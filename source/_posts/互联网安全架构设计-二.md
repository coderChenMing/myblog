---
title: 互联网安全架构设计(二)
date: 2020-01-15 19:36:16
updated: 2020-01-15 20:45:12
tags: web安全
categories: 架构设计
---
## 什么是防盗链
    第三方网站访问下载非本地域名图片等资源时进行阻止下载
## 如何实现防盗链
    判断Http请求头referer域中的记录来源的值,如果和当前访问的域名不一致,说明该图片可能被其他服务器盗用
    实现: 限制资源(图片,视频，文件等)只能在某个域名(限制某个服务器)来源上进行访问 
    使用过滤器拦截请求,判断请求头中的域名(referer记录)与需要限制的域名访问是否一致,如果不一致,说明可能被盗用,进行拦截
    eg: 自己访问自己域名一致,可以访问资源
        第三方网站访问域名referer是第三方网站域名,与本地域名不一致,提示不能访问
    测试: localhost:9090 页面直接访问localhost:8080/imgs/test.png,提示不能访问该图片
    直接访问localhost:8080/imgs/test.png,提示不能访问该图片
    进入localhost:8080自己页面后,访问该图片,访问成功
    eg: 视频云里黑白名单控制,即使你知道视频地址也无法播放
## 什么是CSRF
    Cross Site Request Forgery ,跨站域请求伪造,也就是大家熟知的钓鱼网站。
    xss利用站点内信任用户,CSRF通过伪装来自受信任用户的请求来利用受信任网站。
    CSRF相对更危险
## 什么是幂等
    保证数据唯一性,不许有重复,可以防止表单重复提交
## 保证幂等解决方案
    1.MVCC方案(乐观锁无锁机制)
        多版本并发控制,该策略主要使用update with condition(更新带条件来防止)来保证多次外部请求调用对系统的影响是一致的。
    在系统设计过程中,合理使用乐观锁,通过version 或者updateTime(timestamp)等其他条件,来做乐观锁的判断条件,这样保证更新操作
    即使在并发情况下,也不会有太大问题。例如:
        select * from tablename where condition= #condition# //取出要更新的对象,带有version
        update tablename set name=#name# ,version=#version+1# where version=#version#
        在更新的过程中利用version来防止其他操作对象并发更新,导致更新丢失。为了避免失败,需要一定的重试机制。
    适用场景:
    2.去重表
        在插入数据的时候,插入去重表,利用数据库的唯一索引特性,保证唯一的逻辑。
    3.悲观锁(阻塞式)
        select for update ,整个执行过程中锁定该订单对应的记录。注意:这种在db读大于写的时候不要用
    适用场景:写多读少
    4.Token机制,防止页面重复提交(推荐)
        业务要求:页面的数据只能被点击提交一次
        发生原因:由于重复点击或者网络重发,或者Nginx重发等情况会导致数据被重复提交
        解决办法:
            集群环境:采用token+redis(redis单线程,处理需要排队)
            单JVM环境:采用token+redis或者token+jvm内存
            处理流程:
            数据提交前要向服务申请token,token放到redis或者jvm内存,token设置有效时间,提交后后台校验token,同时删除token
        生成新的token返回